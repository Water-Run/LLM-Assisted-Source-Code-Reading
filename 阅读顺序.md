### Lua 源码阅读计划与文件索引（Zed 友好版）

| 阶段     | 顺序     | 核心文件                     | 模块/类别                            | 功能简介与阅读重点（Key Takeaways）                                                                              |
| ------ | ------ | ------------------------ | -------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **P1** | **1**  | `lobject.h`, `lobject.c` | **对象系统**（Data Representation）    | **全览基石**：定义 `TValue` 与所有 Lua 数据类型。重点看 `CommonHeader` 宏与 Tagged Union 设计，理解动态类型在 C 中的表示方式。             |
| **P1** | **2**  | `lua.h`, `luaconf.h`     | **公共头文件**（Public Header）         | **用户接口**：对外暴露的 API 与配置宏。`luaconf.h` 值得通读，了解 Lua 如何用宏实现高可移植性（ANSI C）。                                  |
| **P2** | **3**  | `lstate.h`, `lstate.c`   | **全局状态**（Global State）           | **上下文环境**：定义 `lua_State`（线程/栈）与 `global_State`（全局）。重点理解栈（Stack）在内存中的布局方式。                             |
| **P2** | **4**  | `lapi.c`                 | **C API 实现**（API Implementation） | **交互桥梁**：实现 `lua_push*`、`lua_get*` 等。重点观察它如何将外部 C 调用映射为内部 VM 栈操作；这也是 Rust/Lua 绑定的底层原理。                |
| **P3** | **5**  | `ltable.h`, `ltable.c`   | **表实现**（Table Implementation）    | **核心算法**：Lua 唯一的复合数据结构。重点学习“数组部分 + 哈希部分”的混合存储策略，以及用于冲突处理的 Brent 算法变体。                                 |
| **P3** | **6**  | `lopcodes.h`, `lvm.c`    | **虚拟机**（Virtual Machine）         | **执行引擎**：`luaV_execute` 是主循环，`lopcodes.h` 定义指令集。重点看大型 `switch-case` 如何解释执行字节码（如 `OP_ADD`, `OP_CALL`）。 |
| **P3** | **7**  | `ldo.c`                  | **函数调用**（Function Calls）         | **控制流**：管理调用栈（Call Stack）与受保护调用（`pcall`）。重点看 `luaD_precall` 与 `luaD_poscall`。                         |
| **P4** | **8**  | `llex.c`, `lparser.c`    | **词法/语法分析**（Lexer & Parser）      | **编译器前端**：手写递归下降解析器（Recursive Descent），无需 Yacc/Bison，代码紧凑；对你的 Markdown 编译器项目很有参考价值。                   |
| **P4** | **9**  | `lcode.c`                | **代码生成**（Code Generator）         | **编译器后端**：Lua 多为边解析边生成，负责生成字节码指令与控制流结构。                                                               |
| **P5** | **10** | `lgc.c`                  | **垃圾回收**（Garbage Collection）     | **内存管理**：增量式标记-清除（Incremental Mark-and-Sweep）。逻辑较复杂，建议进阶阅读。                                           |
| **P6** | **11** | `lauxlib.c`              | **辅助库**（Auxiliary Library）       | **工具集**：实现 `luaL_*` 系列函数。重点看其如何在核心 API（`lapi.c`）之上封装更易用的高级接口。                                         |
| **P6** | **12** | `lua.c`                  | **宿主程序**（Standalone Interpreter） | **CLI 范例**：标准解释器 `lua` 命令的源码。重点看初始化、命令行参数处理与 REPL 循环，作为 CLI 工具开发参考。                                   |
| **P7** | **13** | `l*lib.c`（如 `lstrlib.c`） | **标准库**（Standard Libraries）      | **库实现**：string/io/math 等标准库的 C 实现。可先选熟悉模块（如 string），观察其注册到 Lua 环境的方式。                                 |

---

### 快速参考：文件前缀含义

#### 1. 核心虚拟机与运行时 (The Core & VM)

这是 Lua 的心脏，负责执行代码、管理内存和对象。

| 文件名 | 全称展开 (猜测) | 中文释义与功能 |
| --- | --- | --- |
| **lapi.c** | **L**ua **API** | **C 语言接口**。外部 C 程序与 Lua 交互的核心层（如 `lua_pushnumber` 等函数）。 |
| **lvm.c** | **L**ua **V**irtual **M**achine | **虚拟机**。核心执行循环，负责解释和执行字节码指令。 |
| **ldo.c** | **L**ua **Do** (Function Call) | **函数调用与栈管理**。处理函数调用、受保护调用 (pcall) 和协程的挂起/恢复。 |
| **lgc.c** | **L**ua **G**arbage **C**ollector | **垃圾回收器**。负责自动内存回收（标记-清除算法）。 |
| **lstate.c** | **L**ua **State** | **全局状态**。管理全局状态机 (`lua_State`) 的创建和销毁。 |
| **lobject.c** | **L**ua **Object** | **对象操作**。定义 Lua 的基本数据类型（TValue）及其基本操作。 |
| **ltable.c** | **L**ua **Table** | **表**。Lua 核心数据结构 Hash Table 的实现。 |
| **lstring.c** | **L**ua **String** | **字符串管理**。字符串的存储、哈希化和保留字管理。 |
| **ltm.c** | **L**ua **T**ag **M**ethod | **元机制**。实现 Metatable（元表）和 Metamethod（元方法）的逻辑。 |
| **lfunc.c** | **L**ua **Func**tion | **函数辅助**。处理函数原型 (Proto) 和闭包 (Closure) 的创建。 |
| **lmem.c** | **L**ua **Mem**ory | **内存接口**。封装底层的 `realloc` 等内存分配函数。 |
| **lzio.c** | **L**ua **Z** (Buffered) **IO** | **缓冲输入流**。Lua 内部使用的带缓冲区的输入流接口（用于词法分析等）。 |

#### 2. 解析与编译 (Parsing & Compiling)

这部分负责将 Lua 源代码 (`.lua`) 转换成虚拟机能执行的字节码。

| 文件名 | 全称展开 (猜测) | 中文释义与功能 |
| --- | --- | --- |
| **llex.c** | **L**ua **Lex**er | **词法分析器**。将源代码文本切割成一个个 Token（标记）。 |
| **lparser.c** | **L**ua **Parser** | **语法分析器**。分析 Token 流，构建语法结构。 |
| **lcode.c** | **L**ua **Code** Generator | **代码生成器**。将语法结构转换为对应的指令（Instruction）。 |
| **ldump.c** | **L**ua **Dump** | **字节码序列化**。将编译后的字节码保存为二进制块（通常用于 `luac`）。 |
| **lundump.c** | **L**ua **Undump** | **字节码加载**。加载预编译的二进制字节码块。 |
| **lopcodes.c** | **L**ua **Opcodes** | **操作码定义**。定义虚拟机的指令集（如 `MOVE`, `ADD` 等）及其属性。 |

#### 3. 标准库 (Standard Libraries)

Lua 内置的那些 `string.xxx`, `math.xxx` 函数就是在这里实现的。

| 文件名 | 全称展开 (猜测) | 中文释义与功能 |
| --- | --- | --- |
| **linit.c** | **L**ua **Init**ialization | **库初始化**。负责打开所有内置标准库的入口文件。 |
| **lbaselib.c** | **L**ua **Base** **Lib**rary | **基础库**。包含 `print`, `type`, `assert`, `_G` 等全局函数。 |
| **lauxlib.c** | **L**ua **Aux**iliary **Lib**rary | **辅助库**。编写 C 扩展时常用的 `luaL_` 开头的工具函数。 |
| **lmathlib.c** | **L**ua **Math** **Lib**rary | **数学库** (`math`). |
| **lstrlib.c** | **L**ua **Str**ing **Lib**rary | **字符串库** (`string`). |
| **ltablib.c** | **L**ua **Tab**le **Lib**rary | **表处理库** (`table`). |
| **liolib.c** | **L**ua **IO** **Lib**rary | **输入输出库** (`io`). |
| **loslib.c** | **L**ua **OS** **Lib**rary | **操作系统库** (`os`). |
| **lcorolib.c** | **L**ua **Coro**utine **Lib**rary | **协程库** (`coroutine`). |
| **ldblib.c** | **L**ua **D**e**b**ug **Lib**rary | **调试库** (`debug`). |
| **lutf8lib.c** | **L**ua **UTF-8** **Lib**rary | **UTF-8 支持库** (`utf8`). |
| **loadlib.c** | **Load** **Lib**rary | **包加载库** (`package`). 负责 `require` 和动态库加载 (.so/.dll)。 |

#### 4. 独立可执行程序 (Executables)

这是你平时在命令行里用的程序。

| 文件名 | 全称展开 (猜测) | 中文释义与功能 |
| --- | --- | --- |
| **lua.c** | **Lua** Interpreter | **解释器入口**。`lua` 命令行的主程序，负责解析参数并启动 REPL。 |
| **luac.c** | **Lua** **C**ompiler | **编译器入口**。`luac` 命令行的主程序，用于将源码编译成字节码文件。 |

#### 5. 头文件与配置 (Headers & Config)

定义常量、宏和类型。

| 文件名 | 全称展开 (猜测) | 中文释义与功能 |
| --- | --- | --- |
| **lua.h** | **Lua** Header | **主头文件**。使用 Lua 必须包含的文件，定义了基本版本和类型。 |
| **luaconf.h** | **Lua** **Conf**iguration | **配置文件**。包含编译选项（如整数大小、系统特定差异），移植 Lua 时常改这里。 |
| **lprefix.h** | **L**ua **Prefix** | **前缀头文件**。通常用于处理不同编译器或 C++ 兼容性的预处理定义。 |
| **llimits.h** | **L**ua **Limits** | **限制定义**。定义内部实现的数值限制（如栈大小、最大指令数）。 |
| **lctype.c/h** | **L**ua **C** **Type** | **字符类型**。类似于 C 标准库的 `<ctype.h>`，但为了跨平台一致性，Lua 自己实现了一套 (`isalnum` 等)。 |
| **ljumptab.h** | **L**ua **Jump** **Tab**le | **跳转表**。这是较新版本 Lua (5.4+) 用于优化虚拟机指令分发（Computed Goto）的文件。 |
| **lopnames.h** | **L**ua **Op**code **Names** | **操作码名称**。用于调试时显示指令名称。 |
